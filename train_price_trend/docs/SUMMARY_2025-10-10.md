
# üß† Project Summary ‚Äî BetfairBotML `train_price_trend` System (2025-10-13)

## ‚öôÔ∏è Environment
- **OS:** Ubuntu Linux (bare metal)
- **CPU:** 36 threads
- **GPU:** NVIDIA RTX 3090 (CUDA)
- **Python:** 3.10
- **Polars:** 1.34.0
- **XGBoost:** 2.1.0 (GPU training works, `device=cuda`)
- **Curated data root:** `/mnt/nvme/betfair-curated`

Directory structure:
```
betfair-curated/market_definitions/sport=horse-racing/date=YYYY-MM-DD/
betfair-curated/orderbook_snapshots_5s/sport=horse-racing/date=YYYY-MM-DD/
betfair-curated/results/sport=horse-racing/date=YYYY-MM-DD/
```

## üìä Data Coverage
- Earliest: 2025-09-05  
- Latest:   2025-10-10  
- Total: 34 days of Betfair horse-racing snapshots and definitions
- Snapshot count: ~20‚Äì30k files/day, ~250‚Äì400k rows/day after filtering

## üß© Model Training Status
### ‚úÖ Latest successful train
```
[trend] rows train=6,921,487  valid=250,000
[trend] valid EV per ¬£1: mean=3.91912  p>0 share=0.964
[trend] saved model ‚Üí /opt/BetfairBotML/train_price_trend/output/models/xgb_trend_reg.json
```
- Model has 17 features (consistent across sim/training)
- GPU training confirmed (`device=cuda`)
- Model file loads correctly in simulations

### üß† Where we left off
The `run_daily_trend.sh` script now performs:
1. Training a new XGBoost model (rolling ~27 days)
2. Adaptive edge sweep (finds edge for 1‚Äì2k trades/day)
3. Confirm simulation and summary generation

---

## üöÄ Latest Simulation (Realistic Test)
Command used:
```bash
python3 /opt/BetfairBotML/train_price_trend/ml/simulate_stream.py   --curated /mnt/nvme/betfair-curated   --asof 2025-10-09 --start-date 2025-10-02 --valid-days 7   --sport horse-racing --preoff-max 30 --horizon-secs 120 --commission 0.02   --model-path /opt/BetfairBotML/train_price_trend/output/models/xgb_trend_reg.json   --edge-thresh 0.0015 --stake-mode flat --bankroll-nom 5000   --odds-min 1.5 --odds-max 5.0 --enforce-liquidity --min-fill-frac 5.0   --per-market-topk 1 --per-market-budget 10 --exit-on-move-ticks 0   --ev-scale 0.05 --ev-cap 0.05 --device cuda   --output-dir /opt/BetfairBotML/train_price_trend/output/stream/confirm_2025-10-09_realistic
```

### üßæ Simulation Output
```
[simulate] Completed 7 day(s).
[simulate] Mean EV/¬£1 over days = 0.002297
[simulate] Trades: n=276,183  ROI_exp=0.006510  ROI_mtm=16.904933
```
‚úÖ Model executes fine  
‚úÖ Realistic EV (‚âà0.2‚Äì0.3% per ¬£)  
‚ö†Ô∏è Trade count still high (~40k/day)

---

## üîÅ Daily Automation
To retrain, tune, and simulate automatically:
```bash
TPD_MIN=1000 TPD_MAX=2000 EDGE_MIN=0.0005 EDGE_MAX=0.003 EDGE_INIT_GRID="0.0005,0.001,0.002" EV_SCALE_GRID="0.05,0.1,0.2" EV_CAP_GRID="0.05" STAKE_MODES_GRID="flat,kelly" ODDS_BANDS_GRID="1.5:5.0,2.2:3.6" EXIT_TICKS_GRID="0,1" LIQ_ENFORCE_GRID="1" MIN_FILL_FRAC_GRID="5.0" TOPK_GRID="1" BUDGET_GRID="5,10" SAMPLE_EV_DENSITY=1 SIM_DEVICE=cuda VALID_DAYS=7 ./train_price_trend/bin/run_daily_trend.sh
```
Outputs:
- Model: `/opt/BetfairBotML/train_price_trend/output/models/xgb_trend_reg.json`
- Sweep: `/opt/BetfairBotML/train_price_trend/output/stream/sweeps/<ASOF>/auto/trials.csv`
- Best config: `/opt/BetfairBotML/train_price_trend/output/stream/sweeps/<ASOF>/auto/best_config.json`
- Confirm summary: `/opt/BetfairBotML/train_price_trend/output/stream/confirm_<ASOF>_auto/summary_<ASOF>.json`

---

## üìà Next Steps
1. Tighten trade frequency (raise edge threshold 0.002‚Äì0.003)
2. Inspect latest `best_config.json`
3. Confirm model with out-of-sample week
4. Optional: enable full hyperparameter tuning
5. Deploy to daily cron

---

## üßæ TL;DR Cheat Sheet
```bash
# Train + sweep + confirm (auto)
./train_price_trend/bin/run_daily_trend.sh

# Check results
ASOF=$(date -d yesterday +%Y-%m-%d)
jq . /opt/BetfairBotML/train_price_trend/output/stream/confirm_${ASOF}_auto/summary_${ASOF}.json

# Manual confirm test
python3 /opt/BetfairBotML/train_price_trend/ml/simulate_stream.py   --curated /mnt/nvme/betfair-curated   --asof $ASOF --start-date $(date -d "$ASOF - 7 days" +%Y-%m-%d) --valid-days 7   --sport horse-racing --model-path /opt/BetfairBotML/train_price_trend/output/models/xgb_trend_reg.json   --edge-thresh 0.002 --ev-scale 0.05 --ev-cap 0.05   --enforce-liquidity --min-fill-frac 5.0 --device cuda   --output-dir /opt/BetfairBotML/train_price_trend/output/stream/manual_confirm
```
